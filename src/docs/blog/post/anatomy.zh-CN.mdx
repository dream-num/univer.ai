---
title: 解剖筛选：如何编写 Univer 插件
desc: 这篇文章以 Univer 团队开发的筛选插件为例，介绍如何编写符合 Univer 架构的插件，涉及插件系统、依赖注入、资源加载、命令模式、Render Unit 等等主题，适合想要开发 Univer 插件的开发者阅读。
tags:
  - Plugin
  - Tutorial
  - Custom
  - Architecture
cover: ./anatomy.png
author: Wenzhao Hu
date: 2024-08-27
---

import { Callout } from 'nextra/components'

# 解剖筛选：如何编写 Univer 插件

Univer 提供的 Facade API 使得开发者们可以调用 API 来实现简单的自定义功能。但如果想开发一个全新的功能，或根据需求进行深度定制，那么就需要了解 Univer 的架构，并学习如何编写符合架构的插件。

我们将以官方筛选插件为例进行介绍如何编写一个 Univer 插件，涉及插件系统、依赖注入、资源加载、命令模式、Render Unit 等主题。

你可以在 GitHub 上找到 [@univerjs/sheets-filter](https://github.com/dream-num/univer/tree/dev/packages/sheets-filter) 和 [@univerjs/sheets-filter-ui](https://github.com/dream-num/univer/tree/dev/packages/sheets-filter-ui) 两个包的源码。

<Callout type="info" emoji="💡">
  目前我们并没对 npm 包和 Univer 插件做严格区分，有时候我们说插件时，指的有可能是 npm 包，也可能是这个包导出的 `Plugin` 类，请注意。
</Callout>

## 插件的结构

### 如何划分插件

一个复杂的功能往往会拆分在多个 npm 包中，筛选功能有两个 npm 包：

@univerjs/sheets-filter 

* 定义筛选的运行时数据结构以及快照中的数据结构
* 定义改变筛选数据的 mutations
* 实现筛选和 sheet 基本功能的耦合逻辑（例如筛选和插入行列的联动）
* 提供管理多个工作簿和工作表中筛选模型的 `SheetsFilterModel`
* 将以上模块封装在 `UniverSheetsFilterPlugin` 当中

@univerjs/sheets-filter-ui

* 实现筛选功能的渲染，包括筛选选区，筛选按钮
* 实现筛选功能的 UI，包括筛选面板、菜单栏
* 实现其他交互，例如快捷键
* 提供管理筛选面板的 `SheetsFilterPanelService`
* 将以上模块封装在 `UniverSheetsFilterUIPlugin` 当中

拆分成两个包的原因是： `@univerjs/sheets-filter-ui` 中的代码需要依赖 DOM，而 `@univerjs/sheets-filter` 中的代码是纯逻辑代码，不依赖 DOM，可以在 Node.js 和 Web Worker 环境中运行，用于协同编辑、远端计算等场景。通过拆分，我们可以方便地复用 `@univerjs/sheets-filter` 的代码，来发挥 Univer 架构的同构优势。

<Callout type="info" emoji="💡">
  关于如何划分插件，可以参考架构文档的 [相关章节](guides/sheet/architecture/univer#如何划分插件)。
</Callout>

### 插件的目录结构

每个插件有相似的目录结构，例如 sheets-filter-ui 的目录结构如下：

```plaintext
.
|-- README.md
|-- package.json
|-- src
|   |-- __testing__ // 测试资源文件
|   |   `-- data.ts
|   |-- commands
|   |   |-- commands // CommandType.COMMAND 类型的命令
|   |   `-- operations // CommandType.OPERATION 类型的命令
|   |-- controllers
|   |   |-- __tests__ // 测试用例
|   |   |-- sheets-filter-permission.controller.ts // 权限相关逻辑
|   |   |-- sheets-filter-ui-desktop.controller.ts // 桌面端 UI
|   |   |-- sheets-filter-ui-mobile.controller.ts // 移动端 UI
|   |   |-- sheets-filter.menu.ts // 菜单项
|   |   `-- sheets-filter.shortcut.ts // 快捷键
|   |-- filter-ui-desktop.plugin.ts // 桌面端插件
|   |-- filter-ui-mobile.plugin.ts // 移动端插件（实验性质、未公开发布）
|   |-- index.ts // 包入口文件，资源从这里导出
|   |-- locale // 国际化资源
|   |   |-- en-US.ts
|   |   |-- ru-RU.ts
|   |   |-- vi-VN.ts
|   |   |-- zh-CN.ts
|   |   `-- zh-TW.ts
|   |-- models // 数据模型，为筛选配置面板所用
|   |   |-- __tests__
|   |   |-- conditions.ts
|   |   |-- extended-operators.ts
|   |   `-- utils.ts
|   |-- services
|   |   |-- __tests__
|   |   `-- sheets-filter-panel.service.ts // 管理筛选配置面板状态和表单数据的服务
|   |-- views
|   |   |-- components // React 组件
|   |   |-- render-modules // 渲染模块
|   |   `-- widgets // Canvas 绘制的组件
|   |-- vite-env.d.ts
|   `-- worker // 在 Web Worker 中运行的代码
|       |-- generate-filter-values.service.ts // 计算筛选面板中的选项
|       `-- plugin.ts
|-- tsconfig.json
|-- tsconfig.node.json
`-- vite.config.ts
```

目录结构基本遵从了 Univer 的分层模型，能让熟悉 Univer 的开发者能够快速上手，有助于代码的维护。

作为对比，sheets-filter 插件有相似的目录结构：

```plaintext
.
|-- README.md
|-- docs
|   |-- README.md
|   `-- architecture.excalidraw
|-- package.json
|-- src
|   |-- commands
|   |   `-- mutations // CommandType.MUTATION 类型的命令
|   |-- controllers
|   |   `-- sheets-filter.controller.ts // 和电子表格基础功能耦合的部分，例如插入行列时修改筛选范围
|   |-- index.ts
|   |-- models // 筛选数据模型
|   |   |-- __tests__
|   |   |-- custom-filters.ts // 条件筛选
|   |   |-- filter-model.ts // 运行时筛选数据结构
|   |   `-- types.ts // 快照数据结构
|   |-- plugin.ts
|   |-- services
|   |   `-- sheet-filter.service.ts // 管理多个工作簿和工作表中筛选模型的服务
|   |-- utils.ts
|   `-- vite-env.d.ts
|-- tsconfig.json
|-- tsconfig.node.json
`-- vite.config.ts
```

<Callout type="info" emoji="💡">
  进一步了解 Univer 架构中的 [分层模型](/guides/sheet/architecture/univer#以分层架构划分模块)。
</Callout>

<Callout type="info" emoji="💡">
  你可以使用官方提供的 [CLI 工具](https://www.npmjs.com/package/@univerjs/create-cli) 来创建插件。
</Callout>

## 自定义数据

需要自定义数据的插件需要设计：快照数据结构、内存数据结构以及修改这些数据结构的 mutation，以接入 Univer 系统。

### 快照数据结构

快照中的数据结构将会被存储到数据库中，因此快照数据结构必须是可以被序列化的。筛选插件定义的快照数据格式在 [types.ts](https://github.com/dream-num/univer/blob/dev/packages/sheets-filter/src/models/types.ts) 中。`IAutoFilter` 只使用了基本数据结构，因此可以被 JSON 简单的序列化和反序列化。

<Callout type="info" emoji="💡">
  官方文档中介绍了 [快照](/guides/sheet/getting-started/concepts#快照) 的概念。
</Callout>

<Callout type="info" emoji="💡">
  Univer 官方实现的 sheet 功能插件在定义快照数据结构时会参考 [OOXML 规范](http://officeopenxml.com/)，以便和 Excel 兼容。
</Callout>

### 内存数据结构

快照数据结构可能不适宜直接在内存中使用（例如执行查询、修改的时间复杂度高），因此需要定义一个内存数据结构。筛选插件定义的内存数据结构在 [filter-model.ts](https://github.com/dream-num/univer/blob/dev/packages/sheets-filter/src/models/filter-model.ts) 中。

### `IResourcesManagerService`

定义了两种数据结构之后，我们需要在合适的时机将快照数据结构转换为内存数据结构或者相反，这个过程需要通过 `IResourceManagerService` 来完成。筛选功能在 [sheets-filter.service.ts](https://github.com/dream-num/univer/blob/f68e8ebe85db46801dd579e2f2d772c8ab9d18fc/packages/sheets-filter/src/services/sheet-filter.service.ts#L186) 定义了相关操作。

<Callout type="info" emoji="💡">
  可参考 [插件自定义模型](/guides/sheet/advanced/custom-model) 了解详情。
</Callout>

### mutations

在 Univer 中，对数据结构的修改均需要通过 MUTATION 类型的命令来完成，否则无法实现 undo redo、协同编辑、历史记录等功能。筛选的 mutation 定义在 [sheets-filter.mutation.ts](https://github.com/dream-num/univer/blob/dev/packages/sheets-filter/src/commands/mutations/sheets-filter.mutation.ts) 中。

<Callout type="info" emoji="💡">
  请阅读 [命令系统](/guides/sheet/architecture/univer#命令系统) 了解详情。
</Callout>

## 和 sheet 基础功能的耦合

插件的功能往往需要和 sheet 基础功能耦合，筛选插件的耦合逻辑位于 [sheets-filter.controller.ts](https://github.com/dream-num/univer/blob/dev/packages/sheets-filter/src/controllers/sheets-filter.controller.ts) 中。

<Callout emoji="🤔">
  在处理和 sheet 基础功能耦合的逻辑时，往往需要调用 [`SheetInterceptorService`](/typedoc/@univerjs/sheets/classes/SheetInterceptorService) 的相关方法，可参考 API 文档和已有插件的使用。
</Callout>

## 渲染

### Sheet 选区和按钮

Univer 允许功能插件自定义渲染，筛选插件的渲染模块位于 [sheets-filter.render-controller.ts](https://github.com/dream-num/univer/blob/dev/packages/sheets-filter-ui/src/views/widgets/render-modules/sheets-filter.render-controller.ts)。

`SheetsFilterRenderController` 是一个 `IRenderModule`，它定义了渲染筛选选区和按钮的逻辑。

<Callout type="info" emoji="💡">
  请阅读 [渲染引擎架构设计](/guides/sheet/architecture/rendering) 了解如何撰写渲染层代码。
</Callout>

### 让筛选行隐藏



## 开发 UI

### 菜单项

### 快捷键

### 浮动面板

## 作为封装的插件

### 注册模块

### 处理生命周期

## 国际化

## Facade API

## 总结

<p className="text-gray-500 text-sm mt-8">作者：[Wenzhao Hu](https://github.com/wzhudev)，Head of Engineering</p>
