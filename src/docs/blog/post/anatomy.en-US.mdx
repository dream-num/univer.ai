---
title: 如何编写符合架构的插件
desc: 这篇文章以 Univer 团队开发的筛选插件为例，介绍如何编写符合 Univer 架构的插件，涉及插件系统、依赖注入、资源加载、命令模式、Render Unit 等等主题，适合想要开发 Univer 插件的开发者阅读。
tags:
  - Plugin
  - Tutorial
  - Custom
  - Architecture
cover: ./anatomy.png
author: Wenzhao Hu
date: 2024-08-17
---

import { Callout } from 'nextra/components'

# 如何编写符合架构的插件？

Univer 提供了 Facade API，使得开发者们可以简单地调用 API 来实现一些自定义功能。但是，如果想要深度定制或者是开发一个全新的功能，那么就需要了解 Univer 的架构，并学习如何编写符合架构的插件。

为了帮助那些想要开发 Univer 插件的开发者，我们将以 Univer 团队开发的筛选插件为例进行介绍，涉及插件系统、依赖注入、资源加载、命令模式、Render Unit 等等主题。你可以在 [GitHub](https://github.com/dream-num/univer/tree/dev/packages) 上找到 sheets-filter 和 sheets-filter-ui 两个插件的源码。

---

## 创建插件

在 Univer 中，插件往往会被封装为一个 npm 包，。例如 sheets-filter-ui 插件包的目录结构如下：
筛选功能被划分在两个包当中：

sheets-filter 

* 定义了筛选的运行时 model 以及在 snapshot 中的结构
* 定义了改变这些运行时数据结构的 mutations
* 实现了管理多个工作簿和工作表中筛选 model 的 service
* 将以上模块封装在 `UniverSheetsFilterPlugin` 当中

sheets-filter-ui

* 

<Callout type="info" emoji="💡">
  关于如何划分插件，可以参考架构文档的[相关章节](/guides/sheets/architecture/univer#如何划分插件)。
</Callout>

<Callout>
  你可以使用官方提供的 CLI 来创建一个插件的 npm 包。
</Callout>


```plaintext
.
├── package.json
├── src
│   ├── __testing__ // 用于测试的辅助文件，不包含用例
│   │   └── data.ts
│   ├── commands
│   │   ├── commands
│   │   └── operations
│   ├── controllers
│   │   ├── __tests__ // 放测试用例
│   │   ├── sheets-filter-mobile-ui.controller.ts
│   │   ├── sheets-filter-permission.controller.ts
│   │   ├── sheets-filter-render.controller.ts
│   │   ├── sheets-filter-ui.controller.ts
│   │   ├── sheets-filter.menu.ts
│   │   └── sheets-filter.shortcut.ts
│   ├── index.ts
│   ├── locale // 国际化
│   │   ├── en-US.ts
│   │   ├── ru-RU.ts
│   │   ├── vi-VN.ts
│   │   ├── zh-CN.ts
│   │   └── zh-TW.ts
│   ├── models
│   │   ├── __tests__
│   │   ├── conditions.ts
│   │   ├── extended-operators.ts
│   │   └── utils.ts
│   ├── plugin.ts
│   ├── services
│   │   ├── __tests__
│   │   └── sheets-filter-panel.service.ts
│   ├── views // UI 组件
│   │   ├── components // React 绘制的部分
│   │   └── widgets // Canvas 绘制的部分
│   └── worker
│       ├── generate-filter-values.service.ts
│       └── plugin.ts
```

插件内部按照层次结构来划分代码。

## 加载和落盘资源



## 设计模块

接下来，我们需要设计插件内包含的模块。

## 设计模型


## 使用 ViewModel 来控制 Univer 的渲染

## 编写渲染层

## 使用 React 开发 UI

## 国际化

## Facade API

<p className="text-gray-500 text-sm mt-8">作者：[Wenzhao Hu](https://github.com/wzhudev) Univer 研发 Leader</p>
