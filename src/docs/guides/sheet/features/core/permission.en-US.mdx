import BadgeGroup, { UniverTypes } from '@/components/BadgeGroup'
import Sandbox from '@/components/Sandbox'

import entryFile from './permission/demo-1/index.txt'

# Permission Control

<BadgeGroup values={[UniverTypes.SHEET]} value={UniverTypes.SHEET} />

<Sandbox entryFile={entryFile} />

Univer provides permission control capabilities, typically used to restrict user operations on workbooks, sheets, and ranges. When a user performs an operation without permission, the code execution can be halted and the user will be prompted about the missing permissions. For example, you can set area protection within a range, which allows setting whether other collaborators can edit, read, copy, filter, etc., within the protected range.

**Note: Univer provides extensible basic capabilities and not customized functionalities. Third-party users need to implement permission rule storage and organizational structure integration by themselves. Custom plugins need to be written for this purpose.**
So when you set the permissions and then go to view the permission list, the permission information is empty, or when viewing user information, it returns empty. This is because these pieces of information need to be fetched via API requests; it's custom logic that requires additional implementation on your part. You can refer to the third-party integration below. Please help me translate this.

## Basic Example

### Workbook Permissions

Currently, workbook-level permissions are directly modified through the API. We provide the [Facade API](/guides/sheet/facade/facade), and you can use this API to set permissions for different functions of the workbook.

Taking edit permission as an example (other functions require replacing the permission points, which are listed at the bottom of the article and need to be imported from `@univerjs/sheets`), you can use the following code to set the entire workbook to be non-editable:

```typescript
import { FUniver } from "@univerjs/facade";

const univerAPI = FUniver.newAPI(univer);
```

Then, you can use the univerAPI methods to get the FPermission object and set specific permissions:

```typescript
const permission = univerAPI.getPermission();
// unitId is the workbook id, WorkbookEditablePermission is the permission point, import { WorkbookEditablePermission } from '@univerjs/sheets', false means the permission is not available
permission.setWorkbookPermissionPoint(unitId, WorkbookEditablePermission, false)
```

### Worksheet Permissions Code Example

Worksheet and range-related permissions can be set via API and command modes. Here, we'll use worksheet edit permissions as an example. Other worksheet functions require replacing the permission points, which are listed at the bottom of the article.

#### API Method

```typescript
const permission = univerAPI.getPermission();
// Create worksheet permission, unitId is the workbook id, subUnitId is the sheet id, the generated permission is a basic permission used for rendering permission areas
const permissionId = await permission.addWorksheetBasePermission(unitId, subUnitId);
permission.setWorksheetPermissionPoint(unitId, subUnitId, WorksheetEditPermission, false);
```

#### Command Mode

```typescript
const accessor = univer.__getInjector();
const commandService = accessor.get(ICommandService);
// import { getSheetCommandTarget } from '@univerjs/sheets';
const target = getSheetCommandTarget(univerInstanceService);
if (!target) {
  return;
}
const { unitId, subUnitId } = target;
commandService.executeCommand(AddWorksheetProtectionMutation.id, {
  unitId,
  subUnitId,
  rule: {
    permissionId: "2sxcza1",
    name: "sheet",
    unitType: 2,
    unitId,
    subUnitId,
  },
});

const permissionService = accessor.get(IPermissionService);
permissionService.updatePermissionPoint(new WorksheetEditPermission(unitId, subUnitId).id, false);
```

Parameters in this command: `permissionId` is a unique ID you generate to store the permission, `unitType` is the sheet type (you can use the UnitObject enum from the repository), unitId is the workbook id, and `subUnitId` is the sheet id.

#### Delete Worksheet Permissions

To delete existing worksheet permissions, you can use command mode to drive `DeleteWorksheetProtectionMutation`,` with `unitId` and `subUnitId` as parameters.

```typescript
DeleteWorksheetProtectionMutationParams {
  unitId: string;
  subUnitId: string;
}
```

You can also use the API to delete all permissions settings for a worksheet:

```typescript
const permission = univerAPI.getPermission();
permission.removeWorksheetPermission(unitId, subUnitId);
```

### Custom Range Permissions Code Example

Range permissions can also be set via API and command modes. Here, we'll use range edit permissions as an example. Other range functions require replacing the permission points, which are listed at the bottom of the article.

#### API Method

```typescript
const permission = univerAPI.getPermission();
const res = await permission.addRangeBasePermission(unitId, subUnitId, ranges);
// The response differs from worksheet permissions as a sheet may have multiple range protections, so ruleId is used for storing the unique permission rule, and permissionId is for combining permission points.
const { permissionId, ruleId } = res;
permission.setRangeProtectionPermissionPoint(unitId, subUnitId, permissionId, RangeProtectionPermissionEditPoint, false);
```

#### Command Mode

```typescript
const accessor = univer.__getInjector();
const commandService = accessor.get(ICommandService);
const sheetSelectionManagerService = accessor.get(SheetsSelectionsService);
// import { getSheetCommandTarget } from '@univerjs/sheets';
const target = getSheetCommandTarget(univerInstanceService);
if (!target) {
  return;
}
const { unitId, subUnitId } = target;
const ranges = sheetSelectionManagerService.getCurrentSelections().map(selection => selection.range);
commandService.executeCommand(AddRangeProtectionMutation.id, {
  unitId,
  subUnitId,
  rules: [{
    permissionId: "3xtfxG1",
    name: "sheet1",
    unitType: 3,
    unitId,
    subUnitId,
    ranges,
    id: 'rule1'
  }],
});

const permissionService = accessor.get(IPermissionService);
// Here, RangeProtectionPermissionEditPoint's third parameter is the generated permissionId, false means not editable
permissionService.updatePermissionPoint(new RangeProtectionPermissionEditPoint(unitId, subUnitId, "3xtfxG1").id, false);
```

Here, the parameters are similar to those above, with additional `ranges` parameter for selected areas, and `id` parameter for uniquely identifying the rule, used for deletion.  


#### Delete Range Protection Permissions

To delete existing custom range protections, use command mode to drive `DeleteRangeProtectionMutation`, with `unitId`, `subUnitId`, and the `ruleIds` to be deleted.

```typescript
DeleteRangeProtectionMutationParams {
  unitId: string;
  subUnitId: string;
  ruleIds: string[];
}
```

You can also use the API to delete all permission settings for a selection.

```typescript
const permission = univerAPI.getPermission();
permission.removeRangeProtection(unitId, subUnitId, ruleIds);
```

## Extended usage

Here we take `WorkbookEditablePermission` as an example and add permission verification in your own plug-in. Other points are similar.

```typescript
import { WorkbookEditablePermission } from '@univerjs/sheets';
import { IPermissionService } from '@univerjs/core';

class YourService {
  constructor(@IPermissionService private _permissionService: IPermissionService) {

  }

  setWorkbookNotEditable() {
    this._permissionService.updatePermissionPoint(new WorkbookEditablePermission('unitId').id, false);
  }

  setWorkbookEditable() {
    this._permissionService.updatePermissionPoint(new WorkbookEditablePermission('unitId').id, true);
  }
}
```

You can also extend and modify other permission points to achieve permission control for different functions. For a specific list of points, please refer to the bottom of the article.

### How to extend the permission point

```typescript
import { IPermissionService, IPermissionPoint } from '@univerjs/core';

export class CustomPermissionPoint implements IPermissionPoint {
  type = UnitObject.Unkonwn; // your type
  subType = UnitAction.View; // your subType
  status = PermissionStatus.INIT;
  value = true; // Initial values
  id: string;
  constructor(unitId: string, subUnitId: string, customId: string) {
    // The id attribute needs to be guaranteed to be unique throughout `IPermissionService`.
    this.id = `${unitId}.${subUnitId}.${customId}`;
  }
}

class YourService {
  constructor(@IPermissionService private _permissionService: IPermissionService) {
    this._init()
  }

  _init() {
    this._permissionService.addPermissionPoint(new CustomPermissionPoint('unitId','subUnitId','my-id'));
  }
}

// How to use it elsewhere
class ConsumeService {
  constructor(@IPermissionService private _permissionService: IPermissionService) {
  }

  doSomething() {
   const point = this._permissionService.getPermissionPoint(new CustomPermissionPoint('unitId','subUnitId','my-id').id);
   console.log(point.value);
  }

  bindEvent() {
    // This will get an RX object, allowing you to listen for changes to the current permissions and make a list of changes
    const pount$ = this._permissionService.getPermissionPoint$(new CustomPermissionPoint('unitId','subUnitId','my-id').id);
    console.log(pount$);
  }
}
```

### Integration of Third-Party Authorization Service

The logic for determining permissions is typically handled by an external service, which involves a communication process. In the frontend SDK implementation, we use the [AuthzIoLocalService](https://github.com/dream-num/univer/blob/dev/packages/core/src/services/authz-io/authz-io-local.service.ts) to handle this logic.

In a production environment, we need to replace this implementation with a backend service. The frontend needs to implement the corresponding request functions based on the [IAuthzIoService](https://github.com/dream-num/univer/blob/dev/packages/core/src/services/authz-io/type.ts) interface for runtime replacement.

Here's how you can replace it:

```typescript
import { IAuthzIoService, Injector, Univer } from '@univerjs/core';

class YourAuthzService implements IAuthzIoService { }

export class YourPlugin extends Plugin {
  override onStarting(injector: Injector): void {
    injector.add([IAuthzIoService, { useClass: YourAuthzService }]);
  }
}

// By setting the override option to [[IAuthzIoService, null]], you can instruct Univer not to register the built-in IAuthzIoService.
// This way, Univer will use the service provided by YourAuthzService as the implementation of the authorization service.
const univer = new Univer({
  override: [[IAuthzIoService, null]],
});

univer.registerPlugin(YourPlugin);
```

## List of permission point bits

To access the specific code related to permission point at the given URL, you can refer to the [code](https://github.com/dream-num/univer/tree/dev/packages/sheets/src/services/permission/permission-point).

In the case where the permission control of the workbook intersects with the worksheet/range, all permissions must be set to true in order to use them.

### Workbook Permissions

| Permission                           | Description                         |
|--------------------------------------|-------------------------------------|
| WorkbookEditablePermission           | Can edit                            |
| WorkbookPrintPermission              | Can print                           |
| WorkbookCommentPermission            | Can comment                         |
| WorkbookViewPermission               | Can view                            |
| WorkbookCopyPermission               | Can copy                            |
| WorkbookExportPermission             | Can export                          |
| WorkbookManageCollaboratorPermission | Can manage collaborators            |
| WorkbookCreateSheetPermission        | Can create worksheets               |
| WorkbookDeleteSheetPermission        | Can delete worksheets               |
| WorkbookRenameSheetPermission        | Can rename worksheets               |
| WorkbookHideSheetPermission          | Can hide worksheets                 |
| WorkbookDuplicateSheetPermission     | Can duplicate worksheets            |
| WorkbookSharePermission              | Can share                           |
| WorkbookMoveSheetPermission          | Can move worksheets                 |
| WorksheetViewHistoryPermission       | Can view history                    |
| WorksheetRecoverHistoryPermission    | Can recover history                 |

### Worksheet Permissions

| Permission                          | Description                 |
|-------------------------------------|-----------------------------|
| WorksheetCopyPermission             | Can copy                    |
| WorksheetDeleteColumnPermission     | Can delete columns          |
| WorksheetDeleteRowPermission        | Can delete rows             |
| WorksheetFilterPermission           | Can filter                  |
| WorksheetInsertColumnPermission     | Can insert columns          |
| WorksheetInsertHyperlinkPermission  | Can use hyperlinks          |
| WorksheetInsertRowPermission        | Can insert rows             |
| WorksheetPivotTablePermission       | Can use pivot tables        |
| WorksheetSetCellStylePermission     | Can edit cell styles        |
| WorksheetSetCellValuePermission     | Can edit cell values        |
| WorksheetSetColumnStylePermission   | Can set column styles       |
| WorksheetSetRowStylePermission      | Can set row styles          |
| WorksheetSortPermission             | Can sort                    |
| WorksheetViewPermission             | Can view                    |
| WorksheetEditPermission             | Can edit                    |

### Range Protection

| Permission                           | Description                                |
|--------------------------------------|--------------------------------------------|
| RangeProtectionPermissionViewPoint   | Can view content of protected ranges       |
| RangeProtectionPermissionEditPoint   | Can edit protected ranges                  |     
