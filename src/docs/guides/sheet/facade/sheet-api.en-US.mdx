import { Callout } from 'nextra/components'
import BadgeGroup, { UniverTypes } from '@/components/BadgeGroup'
import ReactLive from '@/components/ReactLive'
import ServerNotice from '@/components/ServerNotice'
import VersionBadge from '@/components/VersionBadge'

# Univer Sheet API

<BadgeGroup values={[UniverTypes.SHEET]} value={UniverTypes.SHEET} />

## Concepts

Univer table-related concepts are designed to be as consistent as possible with Excel.

## Workbook

A workbook contains multiple worksheets and can be thought of as an Excel file.

The `unitId` can be used as a unique identifier for the workbook.

### Create a Workbook

The `univer.createUnit(UniverInstanceType.UNIVER_SHEET, {})` method creates and returns the `Workbook` object.

export const code = `const univer = new Univer({
  theme: defaultTheme,
  locale: LocaleType.EN_US,
  locales: {
    [LocaleType.EN_US]: enUS,
  },
});

univer.registerPlugin(UniverRenderEnginePlugin);
univer.registerPlugin(UniverFormulaEnginePlugin);
univer.registerPlugin(UniverUIPlugin, {
  container: 'app',
});

univer.registerPlugin(UniverDocsPlugin, {
  hasScroll: false,
});
univer.registerPlugin(UniverDocsUIPlugin);

univer.registerPlugin(UniverSheetsPlugin);
univer.registerPlugin(UniverSheetsUIPlugin);
univer.registerPlugin(UniverSheetsFormulaPlugin);

// Passing in an empty object will automatically initialize the workbook
univer.createUnit(UniverInstanceType.UNIVER_SHEET, {});`

<ReactLive code={code}  />

### Getting Workbook Data

```typescript
const univerAPI = FUniver.newAPI(univer);
const activeWorkbook = univerAPI.getActiveWorkbook()
const saveData = activeWorkbook.save();
```

### Unload Workbook

When you no longer need a `Workbook`, you can call the `disposeUnit` method on the API instance to unload it.

```typescript
univerAPI.disposeUnit('your-sheet-id')
```

## Worksheet

Worksheets store table data, worksheets belong to the workbook.

A workbook can contain multiple worksheets, and the names of worksheets in the same workbook cannot be duplicated.

The `subUnitId` can be used to uniquely identify a sheet in a workbook.

### Get Worksheets

Get all sheets in a sheet
```typescript
const activeWorkbook = univerAPI.getActiveWorkbook();
const sheets = activeWorkbook.save().sheets;
```

Get Active Worksheet

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  ```

### Get Worksheet Data

```typescript
const activeWorkbook = univerAPI.getActiveWorkbook();
const snapshot = activeWorkbook.save()
const sheet1 = Object.values(snapshot.sheets).find((sheet) => {
  return sheet.name === 'Sheet1'
})
```

### Create a Worksheet

When creating a workbook, if no parameters are passed, a worksheet will be automatically created.

The following example shows how to create a worksheet using the `Workbook.create` method.

export const code2 = `const univer = new Univer({
  theme: defaultTheme,
  locale: LocaleType.EN_US,
  locales: {
    [LocaleType.EN_US]: enUS,
  },
});

univer.registerPlugin(UniverRenderEnginePlugin);
univer.registerPlugin(UniverFormulaEnginePlugin);
univer.registerPlugin(UniverUIPlugin, {
  container: 'app',
});

univer.registerPlugin(UniverDocsPlugin, {
  hasScroll: false,
});
univer.registerPlugin(UniverDocsUIPlugin);

univer.registerPlugin(UniverSheetsPlugin);
univer.registerPlugin(UniverSheetsUIPlugin);
univer.registerPlugin(UniverSheetsFormulaPlugin);

// Passing in an empty object will automatically initialize the workbook
univer.createUnit(UniverInstanceType.UNIVER_SHEET, {})

const univerAPI = FUniver.newAPI(univer);
//const activeWorkbook = univerAPI.getActiveWorkbook();

// Create a new sheet that named 'Sheet2' with 10 rows and 10 columns
//const sheet = activeWorkbook.create('Sheet2', 10, 10)`

<ReactLive code={code2}  />

### Remove Worksheet

Remove Worksheet by worksheet id

```typescript
const sheetId = 'SheetId';
univerAPI.executeCommand('sheet.command.remove-sheet', { subUnitId: sheetId });
```

### Activate Worksheet

To activate a worksheet, you need to know the workbook id and the sheet id.

```typescript
const workbookId = 'WorkbookId';
const sheetId = 'SheetId';
univerAPI.executeCommand('sheet.command.active-sheet', { unitId: workbookId, subUnitId: sheetId });
```

## Row

### insertRowAfter(afterPosition)

Inserts a row after the given row position.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

// This inserts a row after the first row position
sheet.insertRowAfter(0);
```

### insertRowBefore(beforePosition)

Inserts a row before the given row position.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// This inserts a row before the first row position
sheet.insertRowBefore(0);
```

### insertRows(rowIndex, numRows)

Inserts one or more consecutive blank rows in a sheet starting at the specified location.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Shifts all rows down by three
sheet.insertRows(0, 3);
```

### insertRowsAfter(afterPosition, howMany)

Inserts a number of rows after the given row position.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// This inserts five rows after the first row
sheet.insertRowsAfter(0, 5);
```

### insertRowsBefore(beforePosition, howMany)

Inserts a number of rows before the given row position.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// This inserts five rows before the first row
sheet.insertRowsBefore(0, 5);
```

### deleteRow(rowPosition)

Deletes the row at the given row position.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Rows start at "0" - this deletes the first row
sheet.deleteRow(0);
```

### deleteRows(rowPosition, howMany)

Deletes a number of rows starting at the given row position.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Rows start at "0" - this deletes the first two rows
sheet.deleteRows(0, 2);
```

### moveRows(rowSpec, destinationIndex)

Moves the rows selected by the given range to the position indicated by the `destinationIndex`. The `rowSpec` itself does not have to exactly represent an entire row or group of rows to move—it selects all rows that the range spans.

```typescript
// The code below moves rows 1-2 to destination index 5
// This results in those rows becoming rows 3-4
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Selects row 1 and row 2 to be moved
const rowSpec = sheet.getRange(0,0,2,1);
sheet.moveRows(rowSpec, 5);
```

### hideRow(row)

Hides the rows in the given range.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// This hides the first row
const range = sheet.getRange(0,0,0,0);
sheet.hideRow(range);
```

### hideRows(rowIndex, numRows)

Hides one or more consecutive rows starting at the given index. Use 0-index for this method.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Hides the first three rows
sheet.hideRows(0, 3);
```

### unhideRow(row)

Unhides the row in the given range.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// This unhides the first row if it was previously hidden
const range = sheet.getRange(0,0,0,0);
sheet.unhideRow(range);
```

### showRows(rowIndex, numRows)

Unhides one or more consecutive rows starting at the given index. Use 0-index for this method.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Unhides the first three rows
sheet.showRows(0, 3);
```

### setRowHeight(rowPosition, height)

Sets the row height of the given row in pixels. By default, rows grow to fit cell contents. If you want to force rows to a specified height, use `setRowHeightsForced(startRow, numRows, height)`.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Sets the first row to a height of 200 pixels
sheet.setRowHeight(0, 200);
```

### setRowHeights(startRow, numRows, height)

Sets the height of the given rows in pixels. By default, rows grow to fit cell contents. If you want to force rows to a specified height, use `setRowHeightsForced(startRow, numRows, height)`.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Sets the first three rows to a height of 20 pixels
sheet.setRowHeights(0, 3, 20);
```

### setRowHeightsForced(startRow, numRows, height)

Sets the height of the given rows in pixels. By default, rows grow to fit cell contents. When you use `setRowHeightsForced`, rows are forced to the specified height even if the cell contents are taller than the row height.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Sets the first three rows to a height of 5 pixels
sheet.setRowHeightsForced(0, 3, 5);
```

## Column

### insertColumnAfter(afterPosition)

Inserts a column after the given column position.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// This inserts a column after the first column position
sheet.insertColumnAfter(0);
```

### insertColumnBefore(beforePosition)

Inserts a column before the given column position.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// This inserts a column in the first column position
sheet.insertColumnBefore(0);
```

### insertColumns(columnIndex, numColumns)

Inserts one or more consecutive blank columns in a sheet starting at the specified location.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Shifts all columns by three
sheet.insertColumns(0, 3);
```

### insertColumnsAfter(afterPosition, howMany)

Inserts a given number of columns after the given column position.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Inserts two columns after the first column
sheet.insertColumnsAfter(0, 2);
```

### insertColumnsBefore(beforePosition, howMany)

Inserts a number of columns before the given column position.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// This inserts five columns before the first column
sheet.insertColumnsBefore(0, 5);
```

### deleteColumn(columnPosition)

Deletes the column at the given column position.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Columns start at "0" - this deletes the first column
sheet.deleteColumn(0);
```

### deleteColumns(columnPosition, howMany)

Deletes a number of columns starting at the given column position.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Columns start at "0" - this deletes the first two columns
sheet.deleteColumns(0, 2);
```

### moveColumns(columnSpec, destinationIndex)

Moves the columns selected by the given range to the position indicated by the `destinationIndex`. The `columnSpec` itself does not have to exactly represent an entire column or group of columns to move—it selects all columns that the range spans.

```typescript
// The code below moves rows A-B to destination index 5.
// This results in those columns becoming columns C-D.
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Selects column A and column B to be moved.
const columnSpec = sheet.getRange(0,0,1,2);
sheet.moveColumns(columnSpec, 5);
```

### hideColumn(column)

Hides the column or columns in the given range.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// This hides the first column
const range = sheet.getRange(0,0,0,0);
sheet.hideColumn(range);
```

### hideColumns(columnIndex, numColumns)

Hides one or more consecutive columns starting at the given index. Use 0-index for this method.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Hides the first three columns
sheet.hideColumns(0, 3);
```

### unhideColumn(column)

Unhides the column in the given range.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// This unhides the first column if it was previously hidden
const range = sheet.getRange(0,0,0,0);
sheet.unhideColumn(range);
```

### showColumns(columnIndex, numColumns)

Unhides one or more consecutive columns starting at the given index. Use 0-index for this method.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Unhides the first three columns
sheet.showColumns(0, 3);
```

### setColumnWidth(columnPosition, width)

Sets the width of the given column in pixels.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Sets the first column to a width of 200 pixels
sheet.setColumnWidth(0, 200);
```

### setColumnWidths(startColumn, numColumns, width)

Sets the width of the given columns in pixels.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
  
// Sets the first three columns to a width of 200 pixels
sheet.setColumnWidths(0, 3, 200);
```

## Cell

Cell data is stored in the worksheet as a two-dimensional Map, with the first and second indexes representing the row number and column number respectively.

The following is a typical cell object:

```typescript
{
  v: 'Hello, Univer',
  s: 'styleId',
  t: CellValueType.STRING
}
```

For detailed field descriptions, please refer to [Configure Cell Data](/guides/sheet/getting-started/cell-data).

<Callout type="info" emoji="ℹ️">
  Cell operations can be regarded as operations on a range of rows and columns with a height of 1 and a width of 1. For the operation range, please refer to [Range](/guides/sheet/facade/sheet-api#range).
</Callout>

<Callout type="info" emoji="ℹ️">
  The Univer API plugin will also store the extended cell attributes in the `resources` property of the `Workbook`, please refer to [Plugin Custom Model](/guides/customization/model/).
</Callout>

### Cell PointerMove

The `onCellPointerMove` event is fired when a pointer changes coordinates.
```typescript
univerAPI.getSheetHooks().onCellPointerMove((cell) => {
  // Get the cell currently pointed to by the mouse
  console.log(cell);
})
```

### Cell PointerOver

The `onCellPointerOver` event is fired when a pointer is moved into a cell's hit test boundaries.
```typescript
univerAPI.getSheetHooks().onCellPointerOver((cell) => {
  // Get the cell currently pointed to by the mouse
  console.log(cell);
})
```

### Cell DragOver

The `onCellDragOver` event is fired when an element or text selection is being dragged into a cell's hit test boundaries.
```typescript
univerAPI.getSheetHooks().onCellDragOver((cell) => {
  // Get the cell currently pointed to by the mouse
  console.log(cell);
})
```

### Cell Drop

The `onCellDrop` event is fired when an element or text selection is being dropped on the cell.
```typescript
univerAPI.getSheetHooks().onCellDrop((cell) => {
  // Get the cell currently pointed to by the mouse
  console.log(cell);
})
```

### Cell Enters Editing

```typescript
univerAPI.onCommandExecuted((command) => {
  if(command.id === 'sheet.operation.set-cell-edit-visible' && command.params.visible){
    console.log('Cell edit visible')
  }
})
```

### Cell Exits Editing

```typescript
univerAPI.onCommandExecuted((command) => {
  if(command.id === 'sheet.operation.set-cell-edit-visible' && !command.params.visible){
    console.log('Cell edit invisible')
  }
})
```

## Range

A range refers to a rectangular area in a worksheet, which is determined by the starting row number, starting column number, length, and width, or ending row number, ending column number.

### Create a Range

To get a range you need to know the starting row number, starting column number, length and width.

Create a range of A1 cells:

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
const range = sheet.getRange(0, 0, 1, 1);
```

Creates a range of A1:B2:

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
const range = sheet.getRange(0, 0, 2, 2);
```

### Get Range Data

Get the value of the first cell in the range

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

const range = sheet.getRange(0, 0, 2, 2);
const value = range.getValue();
```

Get all cell values in the range

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

const range = sheet.getRange(0, 0, 2, 2);
range.forEach(( row, column, cell) => {
  console.log( row, column, cell);
});
```

Get all formulas in the range

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

const range = sheet.getRange(0, 0, 2, 2);
console.log(range.getFormulas());
```

### Set Range Value

#### Set a single value

If a value or cell object is passed in, all cells in the range will be overwritten. If it starts with `=`, it will be interpreted as a formula.

For example, to set the value of A1:B2 to `Hello, Univer`:
```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

const range = sheet.getRange(0, 0, 2, 2);
range.setValue('Hello, Univer');
```

Set the value of A1+B1 to the formula:
```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

const range = sheet.getRange(0, 0, 2, 2);
range.setValue('=A1+B1');
```

Set the value of A1:B2 to the cell object:
```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

const range = sheet.getRange(0, 0, 2, 2);
range.setValue({
  v: 'Hello, Univer',
  custom: {
      key: 'value',
  },
});
```

#### Set multiple values with an array

The length and width of the array must match the length and width of the range.

You can pass in cell values or cell objects.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

const range = sheet.getRange(0, 0, 2, 2);
range.setValues([
  ['A1', 'B1'],
  ['A2', 'B2'],
]);

range.setValues([
  [{ v: 'A1' }, { v: 'B1' }],
  [{ v: 'A2' }, { v: 'B2' }],
]);
```

#### Set multiple values with an object

If an object is passed in, the primary index of the object represents the row number, and the secondary index represents the column number, and the length and width of the range do not need to match.

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

const range = sheet.getRange(0, 0, 2, 2);
range.setValues({
  0: {
    0: 'A1',
    1: 'B1',
  },
  1: {
    0: 'A2',
    1: 'B2',
  },
});
```

### Get Range Style

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

const range = sheet.getRange(0, 0, 2, 2);
const style = range.getCellStyleData();
```

### Set Range Style

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

const range = sheet.getRange(0, 0, 2, 2);
range
  .setFontWeight('bold')
  .setFontLine('underline')
  .setFontFamily('Arial')
  .setFontSize(24)
  .setFontColor('red');
```

### Clear Range Style

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

const range = sheet.getRange(0, 0, 2, 2);
range
  .setFontWeight(null)
  .setFontLine(null)
  .setFontFamily(null)
  .setFontSize(null)
  .setFontColor(null);
```

### Whether the range is merged

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

const range = sheet.getRange(0, 0, 2, 2);
const isMerged = range.isMerged();
```

### Get the coordinates of the range

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

const range = sheet.getRange(0, 0, 2, 2);
const rect = range.getCellRect(); // width、heigh、left、right、top、bottom、x、y
```

### Get the merge information and coordinates of the range at the same time

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();

const range = sheet.getRange(0, 0, 2, 2);
const cell = range.getCell();
```

## Selection

Univer Sheets support multiple constituencies, so a constituency is an array of ranges, and you can manipulate the constituency data through the range API.

We also provide APIs to get the current selection, set the selection, and listen for changes to the selection.

### Get Active Selection

```typescript
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();\

const selection = sheet.getSelection();
const range = selection.getActiveRange();
```

### Set Selection

Set A1:B2 as the selection

```typescript
const sheetId = 'SheetId';
univerAPI.executeCommand('sheet.operation.set-selections', {
  selections: [{
    range: {
      startRow: 0,
      startColumn: 0,
      endRow: 1,
      endColumn: 1,
      rangeType: 0,
    },
  }],
  subUnitId,
  unitId: activeWorkbook.getId(),
  type: 2,
})
```

### Listen for Selection Changes

```typescript
const activeWorkbook = univerAPI.getActiveWorkbook();
activeWorkbook.onSelectionChange((selection) => {
  console.log(selection);
});
```

### attach a popup to cell <VersionBadge version="0.2.10+" />
```tsx
const sheet = univerAPI.getActiveWorkbook().getActiveSheet();
const range = sheet.getRange(0, 0, 10, 10); // A1:J10

// attach popup to the first cell of range
const disposeable = range.attachPopup({
  // componentKey must be a componet or a key of registered component 
    componentKey: () => <div style={{ width: 100, height: 100, background: '#fff' }}>popup content</div>,
    // if componentKey is a vue3 component, you must set isVue3 to true
    // isVue3: true,
});

// remove the popup
disposeable.dispose();
```

### add float dom to sheet <VersionBadge version="0.2.10+" />

[demo](https://stackblitz.com/edit/awesome-univer-sheets-vite-demo-fqsu99?file=package.json,src%2Fmain.tsx)
1. Depends on `@univerjs/sheets-drawing-ui` plugin
2. Needs to be called after univer rendering is completed
3. `componentKey` must pass the registered component id or react/vue3 component. If it is vue3 component, it must be marked isVue3

```tsx
const disposeable = worksheet.addFloatDomToPosition({
    // componentKey must be a componet or a key of registered component 
    componentKey: ({ data }) => (
        <div style={{ width: '100%', height: '100%', background: '#fff' }}>
            popup content
            {data?.label}
        </div>
    ),
    // if componentKey is a vue3 component, you must set isVue3 to true
    // isVue3: true,
    initPosition: {
        startX: 100,
        endX: 200,
        startY: 100,
        endY: 200,
    },

    // data of this component
    data: {
        label: 'hahah',
    },
});

// remove the float dom
disposeable.dispose();
```

## Server-Related Features

<ServerNotice />

### Import XLSX

To import via API, use the [Server Version of the Facade API](/guides/sheet/facade/facade#use-with-the-univer-server) to call the features provided by the [import/export plugin](/guides/sheet/features/import-export). Make sure to include the necessary dependencies before use.

#### Import XLSX and Get `unitId`

In a collaborative environment, each workbook has a unique `unitId`. Use the API `importXLSXToUnitId` to pass in the `file` parameter and return `unitId`, which can be used to access the workbook. The `file` parameter can be a File object or a URL to a remote file.

```typescript
univerAPI.importXLSXToUnitId(file).then((id)=>{
  console.log(id)
})
```

#### Import XLSX and Get Workbook Data

When using the import XLSX capability separately in a non-collaborative environment, you can use the API `importXLSXToSnapshot` to return the workbook data in the IWorkbookData format.

```typescript
univerAPI.importXLSXToSnapshot(file).then((data)=>{
  console.log(data)
})
```

### Export XLSX

To export via API, use the [Server Version of the Facade API](/guides/sheet/facade/facade#use-with-the-univer-server) to call the features provided by the [import/export plugin](/guides/sheet/features/import-export). Make sure to include the necessary dependencies before use.

#### Export XLSX via `unitId`

Use the API `exportXLSXByUnitId` to pass in the `unitId` parameter and return a File object.

```typescript
univerAPI.exportXLSXByUnitId(unitId).then((file)=>{
  console.log(file)
})
```

### Export XLSX via Workbook Data

Use the API `exportXLSXBySnapshot` to pass in the table data in the `IWorkbookData` format and return a File object.

You can refer to [Getting Workbook Data](/guides/sheet/facade/sheet-api#getting-workbook-data) to get the data in the `IWorkbookData` format.

```typescript
univerAPI.exportXLSXBySnapshot(snapshot).then((file)=>{
  console.log(file)
})
```

## Reference

Please refer to the following API documentation for more information:

- [Facade API](/typedoc/@univerjs/facade/README)
